<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset="UTF-8">
	<title>Workflow Demo</title>
	<!-- Look at using _js/basket.js to cache scripts -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/1.10.10/js/jquery.dataTables.min.js"></script>
	<script type="text/javascript" src="http://www.jeasyui.com/easyui/jquery.easyui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.10/css/jquery.dataTables.min.css"/>
    <LINK REL="stylesheet" HREF="_css/jquery.dataTables_themeroller.css" />
    <!-- link rel="stylesheet" href="_css/jquery.tablesorter.pager.css" / -->
	<LINK REL="stylesheet" HREF="_css/home.css" id="styleid"/>
	<link rel="stylesheet" type="text/css" href="http://www.jeasyui.com/easyui/themes/default/easyui.css">
	<link rel="stylesheet" type="text/css" href="http://www.jeasyui.com/easyui/themes/icon.css">
	<link rel="stylesheet" type="text/css" href="http://www.jeasyui.com/easyui/themes/color.css">
	<link rel="stylesheet" type="text/css" href="http://www.jeasyui.com/easyui/demo/demo.css">
 	<script type="text/javascript" src="_js/queue/crud.js" > </script>
 	<script type="text/javascript" src="_js/cookies.js" > </script>
    <script type="text/javascript" class="init">
        var oTable;
        var json;
        var uName;
        var uRole;
        var uOrg;
        $(document).ready(function() {
           oTable = $("#entries").DataTable({
            processing: true,
            bStateSave: true,
            ajax: {
                url: "./get_entries.php",
                type: "POST",
                data: function(d) {
	                d.uName = $('#user').text();
	                d.uRole = $('#role').text();
	                d.uOrg = $('#org').text();
                },
                dataSrc: "data"
            },
            "bAutoWidth": false,
            columns: [
                { data:  "ENTRY_NUMBER", width: "10%" },
                { data:  "JOB_ID", width: "10%" },
                { data:  "QUEUE_NAME" },
                { data:  "BUSINESS_PROCESS" },
                { data:  "ACTIVITY" },
                { data:  "CREATION_DATE" },
                { data:  "OWNER", width: "10%" },
                { data: "MSG" }
            ]
            });
            /*setInterval( function() {
                oTable.ajax.reload(null, false);
            }, 30000 );*/

            $(document).on('click','#entries tbody tr',function() {
                var row = $(this).closest("tr");
                //alert("The job_id is: "+$(row).find("td:nth-child(2)").text());
                //editEntry($(row).find("td:nth-child(1)").text(),$(row).find("td:nth-child(3)").text(),$(row).find("td:nth-child(4)").text(),$(row).find("td:nth-child(5)").text(), $(row).find("td:nth-child(8)").text());
                deQueue($(row).find("td:nth-child(1)").text());
            });
            $(document).on('click','#log_in', function() {
                    $.ajax({
                        url: "./users.txt",
                        dataSrc: "users",
                        success: function(data) {
                            json = $.parseJSON(data);
                            login();
                        }
                    });
            });
            $(document).on('click','#log_out', function() {
                logout();
            });
        });
    </script>
</head>
<body
    <div class="wrapper">
        <div class="header"></div>
	    <div class="content">
	        <div id="org"></div>
	       <div id="banner">
	        <div id="_info">
	            <div id="user" ></div>
	            <div id="filler">As: </div>
	        </div>
	        <div id="filler2">
	            <div id="role" ></div>
	            <div id="log_in">Login</div>
	        </div>
	      </div>
            <div id="page" >
                <div class="title">My Tasks</div>
                <hr/>
                <table id="entries" class="tablesorter">
                    <thead>
                        <tr>
                            <th >Entry</th>
                            <th >Job</th>
                            <th >Dept</th>
                            <th >Process</th>
                            <th >Activity</th>
                            <th >Since</th>
                            <th >From</th>
                            <th >Msg</th>
                        </tr>
                 </table>
                <div id="toolbar" class="show">
                    <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-add" plain="true" onclick="addEntry()">New Entry</a>
                </div>
	    </div>
	</div>
	</div>
    <div class="footer">
        <p>Created by J. W. Wooten, Ph.D.</p>
    </div>
	<div id="lin" class="easyui-dialog" style="width:400px;height:380px;padding:10px 20px"
			closed="true" buttons="#lin-buttons">
		<div class="ftitle">Login</div>
		<form id="lfm" method="post" novalidate>
			<div class="fitem">
				<label>User:</label>
				<input name="user" class="easyui-textbox" id="userid" required="true">
			</div>
			<div class="fitem">
				<label>Password:</label>
				<input name="passwd" type="password" class="easyui-textbox" id="password" required="true">
			</div>
			<div class="fitem">
				<label>Organization:</label>
				<input name="org" class="easyui-textbox" id="organization" required="true">
			</div>
		</form>
	</div>
	<div id="lin-buttons">
		<a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="authorize()" style="width:90px">Login</a>
		<a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#lin').dialog('close')" style="width:90px">Cancel</a>
	</div>

	<div id="dlg" class="easyui-dialog" style="width:400px;height:380px;padding:10px 20px"
			closed="true" buttons="#dlg-buttons">
		<div class="ftitle">Entry</div>
		<form id="fm" method="post" novalidate>
			<div class="fitem">
				<label>Entry:</label>
				<input name="entry" class="easyui-textbox" required="true">
			</div>
			<div class="fitem">
				<label>Application:</label>
				<input name="application" class="easyui-textbox" required="true">
			</div>
			<div class="fitem">
				<label>Process:</label>
				<input name="process" class="easyui-textbox">
			</div>
			<div class="fitem">
				<label>Activity:</label>
				<input name="activity" class="easyui-textbox">
			</div>
			<div class="fitem">
				<label>Message:</label>
				<input name="msg" class="easyui-textbox" data-options="multiline:true" style="height:100px">
			</div>
		</form>
	</div>
	<div id="dlg-buttons">
	    <div id="sql_buttons" class="show-sql">
		<a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-ok" onclick="saveEntry()" style="width:90px">Save</a>
		<a href="javascript:void(0)" class="easyui-linkbutton c6" iconCls="icon-destoy" onclick="destroyEntry()" style="width:90px">Remove</a>
	   </div>
		<a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" onclick="javascript:$('#dlg').dialog('close')" style="width:90px">Cancel</a>
	</div>
	<script type="text/javascript">
	if( readCookie("logged_in") ) {
	                $("#log_in").text("Logout");
	                $("#log_in").attr('id', 'log_out');
	                $("#user").text(getFromCookie("logged_in", "uName"));
	                $("#role").text(getFromCookie("logged_in", "uRole"));
	                $("#org").text(getFromCookie("logged_in", "uOrg" ));
	                $("#filler").text("As: ");
	} else {
	            $("#log_out").text("Login");
	            $("#log_out").attr('id', 'log_in');
	            $("#user").text("");
	            $("#role").text("");
	            $("#org").text("");
	            $("#filler").text("");
	        }
        var days = 1;
        function login() {
        	        $('#lin').dialog('open').dialog('set Title', 'Login');
	                $('#lfm').form('clear');
            }
	    function authorize() {
	        // This is called when the login div is clicked.
	        // Compare the form data to the json data and if match, createCookie, else logout;
	        //alert("form data: " + document.getElementById("userid").value);
            uName = document.getElementById("userid").value;
            uOrg = document.getElementById("organization").value;
            var pName = document.getElementById("password").value;
            $('#lin').dialog('close');
            //alert("json: "+json[uName].role);
	        if( json[uName] && pName == json[uName].passwd ) {
	                uRole = json[uName].role;
	                var cookieData = 'uName='+uName+'|uRole='+uRole+'|uOrg='+uOrg;
	                createCookie('logged_in', cookieData, days);
	                window.location.reload();
	            } else {
	                alert("The userName, password, and organization did not match our records");
	                logout();
	            }
	        }
	        function logout() {
	            eraseCookie('logged_in');
	            uName = "";
	            uRole = "";
	            uOrg = "";
	            $("#filler").text("");
	            window.location.reload();
	        }
	    function addEntry() {
	        newEntry($("#user").text(), $("#org").text());
	    }
</script>
	<style type="text/css">
	        #dlg-buttons div {
	            float: left;
	            clear: none;
	        }
	         #toolbar.hide {
	            display: none;
	        }
	        #toolbar.show {
	            display: block;
	        }
	        #sql-buttons.hide {
	            display: none;
	        }
	        #sql-buttons.show {
	            display: block;
	        }
	        #fm{
			margin:0;
			padding:10px 30px;
		}
		.ftitle{
			font-size:14px;
			font-weight:bold;
			padding:5px 0;
			margin-bottom:10px;
			border-bottom:1px solid #ccc;
		}
		.fitem{
			margin-bottom:5px;
		}
		.fitem label{
			display:inline-block;
			width:80px;
		}
		.fitem input{
			width:160px;
		}
		.datatable td {
              overflow: hidden; /* this is what fixes the expansion */
              text-overflow: ellipsis; /* not supported in all browsers, but I accepted the tradeoff */
              white-space: nowrap;
        }
        table.tablesorter { /* So it won't keep expanding */
            table-layout: fixed
        }
	</style>
</body>
</html>
